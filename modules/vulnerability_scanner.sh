#!/bin/bash

source ../mahabharata.sh

function vuln_menu {
    show_banner
    echo -e "${CYAN}╔══════════════════════════════════════╗"
    echo -e "║       ${RED}☠️ VULNERABILITY SCANNER ${CYAN}        ║"
    echo -e "╠══════════════════════════════════════╣"
    echo -e "║ ${YELLOW}1. System Package Audit${CYAN}             ║"
    echo -e "║ ${YELLOW}2. CVE Lookup Tool${CYAN}                 ║"
    echo -e "║ ${YELLOW}3. WordPress Vulnerability Scan${CYAN}     ║"
    echo -e "║ ${RED}0. Back to Main Menu${CYAN}                ║"
    echo -e "╚══════════════════════════════════════╝${NC}"
    read -p "Select an option [0-3]: " choice

    case $choice in
        1) package_audit ;;
        2) cve_lookup ;;
        3) wp_scan ;;
        0) ../mahabharata.sh ;;
        *) echo -e "${RED}Invalid choice!${NC}"; sleep 1; vuln_menu ;;
    esac
}

function package_audit {
    echo -e "${GREEN}[+] Checking for outdated packages...${NC}"
    apt list --upgradable 2>/dev/null | tee logs/package_audit_$(date +%Y-%m-%d).log
    echo -e "${YELLOW}\nChecking for vulnerable packages...${NC}"
    grep -i 'vulnerable' /var/log/dpkg.log | tee -a logs/package_audit_$(date +%Y-%m-%d).log
    read -p "Press [Enter] to continue..."
    vuln_menu
}

function cve_lookup {
    echo -e "${GREEN}[+] CVE Lookup Tool${NC}"
    read -p "Enter software name (e.g., openssl): " software
    read -p "Enter version (e.g., 1.1.1): " version
    echo -e "${YELLOW}Searching for CVEs...${NC}"
    curl -s "https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=$software+$version" | grep -A5 "CVE-" | tee logs/cve_scan_$(date +%Y-%m-%d).log
    read -p "Press [Enter] to continue..."
    vuln_menu
}

function wp_scan {
    echo -e "${GREEN}[+] WordPress Vulnerability Scan${NC}"
    read -p "Enter WordPress URL (e.g., https://example.com): " url
    echo -e "${YELLOW}Scanning $url...${NC}"
    if ! command -v wpscan &> /dev/null; then
        echo -e "${RED}WPScan not found! Install with 'gem install wpscan'${NC}"
    else
        wpscan --url $url --no-update --format cli-no-colour | tee logs/wp_scan_$(date +%Y-%m-%d).log
    fi
    read -p "Press [Enter] to continue..."
    vuln_menu
}

vuln_menu
